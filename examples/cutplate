#! /usr/bin/env python

from nutils import *


@log.title
def makeplots( domain, geom, stress ):

  points, colors = domain.simplex.elem_eval( [ geom, stress[0,1] ], ischeme='bezier3', separate=True )
  with plot.PyPlot( 'stress', ndigits=0 ) as plt:
    plt.mesh( points, colors, triangulate='bezier' )
    plt.colorbar()
    plt.axis( 'equal' )
    plt.xlim( 0, 1.5 )


def main( nelems=8, maxrefine=2, stress=library.Hooke(lmbda=1,mu=1), plots=True ):

  verts = numpy.linspace( 0, 1, nelems+1 )
  wholedomain, geom = mesh.rectilinear( [verts,verts] )
  dspace = wholedomain.splinefunc( degree=2 ).vector( 2 )
  levelset = function.norm2( geom ) - .5
  domain = wholedomain.trim( levelset, maxrefine=maxrefine )

  support = domain.integrate( function.norm2( dspace ), geometry=geom, ischeme='gauss6' )
  cons = util.NanVec( len(support) )
  cons[ support==0 ] = 0
  cons |= wholedomain.boundary['left,right'].project( geom*[.5,0], geometry=geom, ischeme='gauss6', onto=dspace )
  cons |= wholedomain.boundary['right'].project( [.5,0], geometry=geom, ischeme='gauss6', onto=dspace )

  elasticity = function.outer( dspace.grad(geom), stress(dspace,geom) ).sum([2,3])
  matrix = domain.integrate( elasticity, geometry=geom, ischeme='gauss6' )
  lhs = matrix.solve( constrain=cons, tol=1e-5, symmetric=True )
  disp = dspace.dot( lhs )

  if plots:
    makeplots( domain, geom+disp, stress(disp,geom) )

  return lhs, cons


def unittest():

  retvals = main( nelems=4, maxrefine=2, plots=False )
  assert debug.CmpData( retvals ) == '''
    eNrNk8tqw0AMRX8nobbQW5rP6SLb/P+yyowm3TcJ1GA4CPnqcWU9LhcErOf2hXj8EQkIRW4nyjFA2KmQ
    KjoUx0QHGviI8mEQyjYxgTR8okII88wtdFoKAjwkJnLlom1dcd2IYvszQm10pWhEHtZiaqmNNAZvJMf9
    Wbg3ZtqvbrejYPEsYUijsTpfCbZW8gK+7sVJkDSXJsfJD9ZeYOqQuewKWw5dLOAZy4/TwQfy5FLxzPaG
    bc4qJcKsLWKQgb7qGDhPqyseZRptr1VlpdcFCGNHiSW7ijLJbkSIdGtz9L2Ug9glHxnCjZiyO9UYC2t2
    5nwOVucXk1/f6vV4w29y/75/9P0P5/fpGd9h5fUHZ3kiAg=='''

  retvals = main( nelems=4, maxrefine=3, plots=False )
  assert debug.CmpData( retvals ) == '''
    eNrN00tuw0AIANDrNKqD+H+O00W2uf+yxMPkAE0i1ZKlJwSMDbYeX18I2NftG/H4IwvCwm9X1KaiSZMO
    gpL0kw6MjE0+DEKRTiaQTVQhROzMbbqtMgGuWGQgJX729dxEiV1GgkNX3UQhmWZqmUOq2lEiq10WsZnp
    +OxLPrTAJ9cLPSg8tDWSF/j6Lq4EifiYlBxXhrQZVTNYzmF32FJ8WcCLctnbsnK6i/EKSzPwbNhbqIid
    jKKyzjFwjmkSvbSy2bXSpDsQVk2USHlO6YTaDyIUumzAofv0KrehYO4oJsXuETl1BMzbXbi+GH7DVC/H
    G36T+8/9o/d/+Pw+/Y7vWOXlF6JbIm4='''


util.run( main, unittest )
